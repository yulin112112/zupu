<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå­æ—è°±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            position: relative; /* ä¸ºç™»å½•æŒ‰é’®å®šä½ */
        }
        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 15px;
        }
        /* å³ä¸Šè§’ç™»å½•æŒ‰é’® */
        .login-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 6px 12px;
            background-color: #FFA500; /* æ©™è‰² */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .login-btn:hover {
            background-color: #e69500; /* æ·±ä¸€ç‚¹çš„æ©™è‰² */
        }
        .buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 0 20px 20px 20px;
            background-color: #fff;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #409eff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #337ecc;
        }
        .btn-success {
            background-color: #67c23a;
            color: white;
        }
        .btn-success:hover {
            background-color: #5daf34;
        }
        .btn-warning {
            background-color: #e6a23c;
            color: white;
        }
        .btn-warning:hover {
            background-color: #d19236;
        }
        .btn-danger {
            background-color: #f56c6c;
            color: white;
        }
        .btn-danger:hover {
            background-color: #d9534f;
        }
        .btn-info {
            background-color: #17a2b8; /* è“è‰² */
            color: white;
        }
        .btn-info:hover {
            background-color: #138496;
        }
        .container {
            display: flex;
            height: calc(100vh - 120px); /* è°ƒæ•´é«˜åº¦ä»¥é€‚åº”å¤´éƒ¨å˜åŒ– */
            padding: 20px;
            gap: 20px;
        }
        .tree-container {
            flex: 3;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            overflow: auto;
            position: relative;
        }
        .info-container {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto; /* ä¿¡æ¯é¢æ¿å†…å®¹è¿‡å¤šæ—¶å¯æ»šåŠ¨ */
        }
        .info-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #409eff;
            padding-bottom: 8px;
        }
        .info-content {
            line-height: 1.6;
        }
        .info-item {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .info-item:last-child {
             border-bottom: none;
             margin-bottom: 0;
             padding-bottom: 0;
        }
        .info-label {
            font-weight: bold;
            color: #555;
            display: inline-block;
            width: 100px; /* ç»Ÿä¸€æ ‡ç­¾å®½åº¦ */
        }
        .info-value {
            color: #333;
        }
        /* å¤´åƒæ ·å¼ - æ–¹å½¢ */
        .avatar-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .avatar {
            width: 120px;
            height: 120px;
            object-fit: cover; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹å¹¶å¡«å……å®¹å™¨ */
            border: 3px solid #409eff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .avatar-placeholder {
            width: 120px;
            height: 120px;
            background-color: #e0e0e0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #999;
            border: 2px dashed #ccc;
        }
        /* å¤šåª’ä½“å†…å®¹æ ·å¼ */
        .media-container {
            margin-top: 5px;
        }
        .media-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 5px;
            border-radius: 4px;
        }
        .video-container {
             position: relative;
             padding-bottom: 56.25%; /* 16:9 å®½é«˜æ¯” */
             height: 0;
             overflow: hidden;
             background-color: #000;
             border-radius: 4px;
             margin-top: 5px;
        }
        .video-container iframe,
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        /* éŸ³é¢‘å®¹å™¨æ ·å¼ */
        .audio-container {
            margin-top: 5px;
            padding: 5px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        /* å¢“åœ°åœ°å›¾å ä½ç¬¦ */
        .map-placeholder {
            width: 100%;
            height: 150px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            margin-top: 5px;
        }
        .node {
            padding: 10px 15px;
            margin: 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-width: 80px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: absolute; /* å…³é”®ï¼šä½¿ç”¨ç»å¯¹å®šä½ */
        }
        .node.male {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }
        .node.female {
            background-color: #fce4ec;
            border: 2px solid #e91e63;
        }
        /* --- ä¿®æ”¹ï¼šé€‰ä¸­èŠ‚ç‚¹çš„è¾¹æ¡†é¢œè‰² --- */
        .node.selected {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 3px solid #FFA500 !important; /* æ©™è‰²è¾¹æ¡† */
            z-index: 10; /* ç¡®ä¿é€‰ä¸­çš„èŠ‚ç‚¹åœ¨æœ€ä¸Šå±‚ */
        }
        /* --- ç»“æŸä¿®æ”¹ --- */
        .node:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .spouse-name {
            font-size: 11px;
            margin-top: 3px;
            opacity: 0.8;
        }
        .no-data {
            text-align: center;
            color: #999;
            font-size: 16px;
            padding: 40px;
        }
        .add-node-form {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        /* Context menu styles */
        .context-menu {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            min-width: 150px;
        }
        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .context-menu-item:hover {
            background-color: #f5f5f5;
        }
        .context-menu-divider {
            height: 1px;
            background-color: #eee;
            margin: 4px 0;
        }
        /* è¿æ¥çº¿æ ·å¼ */
        .connector-line {
            position: absolute;
            background-color: #999;
        }
        .vertical-line {
            width: 2px;
        }
        .horizontal-line {
            height: 2px;
        }
        /* éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† */
        .file-input {
            display: none;
        }
        /* å•ä¸ªåª’ä½“é¡¹å®¹å™¨ */
        .media-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
            background-color: #fafafa;
        }
        .media-item:last-child {
            margin-bottom: 0;
        }
        .media-item-text {
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œå’Œç©ºæ ¼ */
        }
        /* å¤´åƒæ“ä½œæŒ‰é’® */
        .avatar-actions {
            margin-top: 10px;
        }
        .avatar-btn {
            padding: 5px 10px;
            margin: 0 5px;
            font-size: 12px;
        }
        /* å¤šåª’ä½“ç®¡ç†æŒ‰é’® */
        .media-actions {
            margin-top: 8px;
        }
        .media-btn {
            padding: 4px 8px;
            margin-right: 5px;
            font-size: 12px;
        }
        /* æ¡ç›®å®¹å™¨ */
        .entry-container {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fafafa;
        }
        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .entry-title-input {
            font-weight: bold;
            color: #555;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px;
            width: 70%;
        }
        .entry-actions {
            display: flex;
            gap: 5px;
        }
        .entry-content {
            margin-top: 8px;
        }
        .entry-text-input {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }
        .add-entry-btn {
            margin-top: 10px;
            padding: 6px 12px;
            font-size: 13px;
        }
        .entry-media-preview {
            margin-top: 8px;
        }
        /* ç©ºé—´æŒ‰é’®æ ·å¼ */
        .space-btn {
            margin-top: 5px;
            padding: 6px 12px;
            font-size: 13px;
        }
        /* å¯¼å…¥å¯¼å‡ºæç¤º */
        .import-hint {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #333;
        }
        .import-hint strong {
            color: #0066cc;
        }
        /* ä»£æ•°æ¡†æ ·å¼ */
        .generation-box {
            position: absolute;
            left: 20px; /* åˆå§‹ä½ç½®ï¼Œä¼šè¢«calculateGenerationsLayoutåŠ¨æ€è°ƒæ•´ */
            padding: 10px 15px;
            margin: 5px;
            border-radius: 6px;
            background-color: #e0f7fa;
            border: 2px solid #2196f3;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-width: 80px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 5;
        }
        .generation-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .generation-box-editing {
            background-color: #fff;
            border: 2px solid #2196f3;
        }
        .generation-box input[type="text"] {
            width: 100%;
            padding: 5px;
            border: none;
            outline: none;
            font-size: 14px;
            text-align: center;
        }
        /* ä»£æ•°è¿æ¥çº¿ */
        .generation-line {
            position: absolute;
            background-color: #2196f3;
            width: 2px;
            z-index: 4;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>æ—è°±</h1>
        <!-- å³ä¸Šè§’ç™»å½•æŒ‰é’® -->
        <button class="login-btn" onclick="alert('ç™»å½•åŠŸèƒ½å¾…å®ç°')">ç™»å½•</button>
    </div>
    <div class="buttons">
        <button class="btn btn-success" onclick="saveFamilyTree()">ä¿å­˜</button>
        <button class="btn btn-warning" onclick="importFamilyTree()">å¯¼å…¥</button>
        <button class="btn btn-primary" onclick="exportFamilyTree()">å¯¼å‡º</button>
        <button class="btn btn-primary" onclick="showAddRootModal()">æ·»åŠ æ ¹èŠ‚ç‚¹</button>
        <button class="btn btn-danger" onclick="clearFamilyTree()">æ¸…é™¤æ—è°±</button>
    </div>
    <div class="container">
        <div class="tree-container">
            <div id="familyTree">
                <div class="no-data" id="noData">æš‚æ— æ—è°±æ•°æ®ï¼Œè¯·æ·»åŠ æ ¹èŠ‚ç‚¹</div>
                <div id="treeContent"></div>
            </div>
        </div>
        <div class="info-container">
            <div class="info-title">äººå‘˜ä¿¡æ¯</div>
            <div class="info-content" id="personInfo">
                <div class="no-data">è¯·é€‰æ‹©æ—è°±ä¸­çš„äººå‘˜æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>
            </div>
        </div>
    </div>
    <!-- å³é”®èœå• -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="showAddParentModal()">æ·»åŠ çˆ¶èŠ‚ç‚¹</div>
        <div class="context-menu-item" onclick="showAddChildModal()">æ·»åŠ å­èŠ‚ç‚¹</div>
        <div class="context-menu-item" onclick="showEditModal()">ç¼–è¾‘èŠ‚ç‚¹</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="deleteNode()" style="color: #f56c6c;">åˆ é™¤èŠ‚ç‚¹</div>
    </div>
    <!-- æ·»åŠ æ ¹èŠ‚ç‚¹æ¨¡æ€æ¡† (ç²¾ç®€ç‰ˆ) -->
    <div id="addRootModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æ·»åŠ æ ¹èŠ‚ç‚¹</div>
                <span class="close" onclick="closeModal('addRootModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>å§“åï¼š</label>
                    <input type="text" id="rootName" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                <div class="form-group">
                    <label>æ€§åˆ«ï¼š</label>
                    <select id="rootGender">
                        <option value="male">ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label>é…å¶å§“åï¼š</label>
                    <input type="text" id="rootSpouseName" placeholder="è¯·è¾“å…¥é…å¶å§“å">
                </div>
                <div class="form-group">
                    <label>æ°‘æ—ï¼š</label>
                    <input type="text" id="rootEthnicity" placeholder="è¯·è¾“å…¥æ°‘æ—">
                </div>
                <div class="form-group">
                    <label>å‡ºç”Ÿæ—¥æœŸï¼š</label>
                    <input type="date" id="rootBirthDate">
                </div>
                <div class="form-group">
                    <label>æ­»äº¡æ—¥æœŸï¼š</label>
                    <input type="date" id="rootDeathDate">
                </div>
                 <!-- ç§»é™¤ç”Ÿå¹³ä»‹ç»ã€èº«åäº‹ã€å¢“åœ°ç­‰å­—æ®µ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addRootModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addRootNode()">ç¡®å®š</button>
            </div>
        </div>
    </div>
    <!-- æ·»åŠ çˆ¶èŠ‚ç‚¹æ¨¡æ€æ¡† (ç²¾ç®€ç‰ˆ) -->
    <div id="addParentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æ·»åŠ çˆ¶èŠ‚ç‚¹</div>
                <span class="close" onclick="closeModal('addParentModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>å§“åï¼š</label>
                    <input type="text" id="parentName" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                <div class="form-group">
                    <label>æ€§åˆ«ï¼š</label>
                    <select id="parentGender">
                        <option value="male">ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label>é…å¶å§“åï¼š</label>
                    <input type="text" id="parentSpouseName" placeholder="è¯·è¾“å…¥é…å¶å§“å">
                </div>
                <div class="form-group">
                    <label>æ°‘æ—ï¼š</label>
                    <input type="text" id="parentEthnicity" placeholder="è¯·è¾“å…¥æ°‘æ—">
                </div>
                <div class="form-group">
                    <label>å‡ºç”Ÿæ—¥æœŸï¼š</label>
                    <input type="date" id="parentBirthDate">
                </div>
                <div class="form-group">
                    <label>æ­»äº¡æ—¥æœŸï¼š</label>
                    <input type="date" id="parentDeathDate">
                </div>
                <!-- ç§»é™¤ç”Ÿå¹³ä»‹ç»ã€èº«åäº‹ã€å¢“åœ°ç­‰å­—æ®µ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addParentModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addParentNode()">ç¡®å®š</button>
            </div>
        </div>
    </div>
    <!-- æ·»åŠ å­èŠ‚ç‚¹æ¨¡æ€æ¡† (ç²¾ç®€ç‰ˆ) -->
    <div id="addChildModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æ·»åŠ å­èŠ‚ç‚¹</div>
                <span class="close" onclick="closeModal('addChildModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>å§“åï¼š</label>
                    <input type="text" id="childName" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                <div class="form-group">
                    <label>æ€§åˆ«ï¼š</label>
                    <select id="childGender">
                        <option value="male">ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label>é…å¶å§“åï¼š</label>
                    <input type="text" id="childSpouseName" placeholder="è¯·è¾“å…¥é…å¶å§“å">
                </div>
                <div class="form-group">
                    <label>æ°‘æ—ï¼š</label>
                    <input type="text" id="childEthnicity" placeholder="è¯·è¾“å…¥æ°‘æ—">
                </div>
                <div class="form-group">
                    <label>å‡ºç”Ÿæ—¥æœŸï¼š</label>
                    <input type="date" id="childBirthDate">
                </div>
                <div class="form-group">
                    <label>æ­»äº¡æ—¥æœŸï¼š</label>
                    <input type="date" id="childDeathDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addChildModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addChildNode()">ç¡®å®š</button>
            </div>
        </div>
    </div>
    <!-- æ·»åŠ é…å¶æ¨¡æ€æ¡† (å®Œæ•´ç‰ˆ) -->
    <div id="addSpouseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æ·»åŠ é…å¶</div>
                <span class="close" onclick="closeModal('addSpouseModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>å§“åï¼š</label>
                    <input type="text" id="spouseName" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                <div class="form-group">
                    <label>æ€§åˆ«ï¼š</label>
                    <select id="spouseGender">
                        <option value="male">ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ°‘æ—ï¼š</label>
                    <input type="text" id="spouseEthnicity" placeholder="è¯·è¾“å…¥æ°‘æ—">
                </div>
                <div class="form-group">
                    <label>å‡ºç”Ÿæ—¥æœŸï¼š</label>
                    <input type="date" id="spouseBirthDate">
                </div>
                <div class="form-group">
                    <label>æ­»äº¡æ—¥æœŸï¼š</label>
                    <input type="date" id="spouseDeathDate">
                </div>
                <div class="form-group">
                    <label>ç”Ÿå¹³ä»‹ç»ï¼š</label>
                    <textarea id="spouseBiography" placeholder="è¯·è¾“å…¥ç”Ÿå¹³ä»‹ç»"></textarea>
                </div>
                <div class="form-group">
                    <label>èº«åäº‹ï¼š</label>
                    <textarea id="spouseAfterlife" placeholder="è¯·è¾“å…¥èº«åäº‹"></textarea>
                </div>
                 <div class="form-group">
                    <label>å¢“åœ°ï¼š</label>
                    <input type="text" id="spouseGraveLocation" placeholder="è¯·è¾“å…¥å¢“åœ°ä¿¡æ¯">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addSpouseModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addSpouseNode()">ç¡®å®š</button>
            </div>
        </div>
    </div>
    <!-- ç¼–è¾‘èŠ‚ç‚¹æ¨¡æ€æ¡† (ç²¾ç®€ç‰ˆ) -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ç¼–è¾‘èŠ‚ç‚¹</div>
                <span class="close" onclick="closeModal('editModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>å§“åï¼š</label>
                    <input type="text" id="editName" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                <div class="form-group">
                    <label>æ€§åˆ«ï¼š</label>
                    <select id="editGender">
                        <option value="male">ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label>é…å¶å§“åï¼š</label>
                    <input type="text" id="editSpouseName" placeholder="è¯·è¾“å…¥é…å¶å§“å">
                </div>
                <div class="form-group">
                    <label>æ°‘æ—ï¼š</label>
                    <input type="text" id="editEthnicity" placeholder="è¯·è¾“å…¥æ°‘æ—">
                </div>
                <div class="form-group">
                    <label>å‡ºç”Ÿæ—¥æœŸï¼š</label>
                    <input type="date" id="editBirthDate">
                </div>
                <div class="form-group">
                    <label>æ­»äº¡æ—¥æœŸï¼š</label>
                    <input type="date" id="editDeathDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="editNode()">ç¡®å®š</button>
            </div>
        </div>
    </div>
    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†ç”¨äºå¯¼å…¥ -->
    <input type="file" id="fileInput" class="file-input" accept=".zip" onchange="handleFileImport(event)">
    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†ç”¨äºä¸Šä¼ å¤´åƒ -->
    <input type="file" id="avatarInput" class="file-input" accept="image/*" onchange="handleAvatarUpload(event)">
    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†ç”¨äºä¸Šä¼ å¤šåª’ä½“æ–‡ä»¶ -->
    <input type="file" id="mediaInput" class="file-input" accept="image/*, video/*, audio/*" onchange="handleMediaUpload(event)">
    <script>
        // æ—è°±æ•°æ®ç»“æ„
        let familyTree = [];
        let selectedPerson = null;
        let contextMenuPerson = null;
        let nextId = 1;
        let currentMediaField = null; // ç”¨äºæ ‡è¯†å½“å‰æ­£åœ¨æ“ä½œçš„å¤šåª’ä½“å­—æ®µ
        let currentEntryId = null; // ç”¨äºæ ‡è¯†å½“å‰æ­£åœ¨æ“ä½œçš„æ¡ç›®ID
        let currentMediaAction = null; // ç”¨äºæ ‡è¯†å½“å‰åª’ä½“æ“ä½œç±»å‹ ('add', 'replace')
        let currentMediaItemId = null; // ç”¨äºæ ‡è¯†å½“å‰æ­£åœ¨æ›¿æ¢çš„åª’ä½“é¡¹ID
        // èŠ‚ç‚¹å’Œè¿çº¿çš„å°ºå¯¸å¸¸é‡
        const NODE_WIDTH = 100;
        const NODE_HEIGHT = 60;
        const LEVEL_HEIGHT = 120; // å±‚çº§ä¹‹é—´çš„å‚ç›´è·ç¦»
        const SIBLING_SPACING = 30; // å…„å¼ŸèŠ‚ç‚¹ä¹‹é—´çš„æ°´å¹³è·ç¦»
        // ä»£æ•°ä¿¡æ¯å­˜å‚¨
        let generationInfo = {}; // { depth: { id: uniqueId, text: "ç¬¬Nä»£" } }
        // åˆå§‹åŒ–
        function init() {
            loadFamilyTree();
            renderFamilyTree();
            // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶æ¥å…³é—­å³é”®èœå•
            document.addEventListener('click', function() {
                document.getElementById('contextMenu').style.display = 'none';
            });
        }
        // åŠ è½½æ—è°±æ•°æ®
        function loadFamilyTree() {
            // è¿™é‡Œå¯ä»¥æ›¿æ¢ä¸ºä»æœåŠ¡å™¨åŠ è½½æ•°æ®
            // æš‚æ—¶ä½¿ç”¨ç©ºæ•°ç»„
        }
        // è®¡ç®—æ ‘çš„å¸ƒå±€ (ä¼˜åŒ–ç‰ˆ - æ”¹è¿›è¿çº¿)
        function calculateLayout() {
            if (familyTree.length === 0) return { nodes: [], lines: [] };
            // æ„å»º ID åˆ°èŠ‚ç‚¹çš„æ˜ å°„ï¼Œæ–¹ä¾¿æŸ¥æ‰¾
            const nodeMap = {};
            familyTree.forEach(person => {
                nodeMap[person.id] = person;
                // åˆå§‹åŒ–åæ ‡å’Œå­èŠ‚ç‚¹æ•°ç»„
                person.x = 0;
                person.y = 0;
                person.childrenNodes = [];
            });
            // å»ºç«‹çˆ¶å­å…³ç³»
            familyTree.forEach(person => {
                if (person.parentId && nodeMap[person.parentId]) {
                    nodeMap[person.parentId].childrenNodes.push(person);
                }
            });
            // æ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼ˆæ²¡æœ‰çˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼‰
            const rootNodes = familyTree.filter(person => !person.parentId);
            // ç”¨äºå­˜å‚¨æ‰€æœ‰èŠ‚ç‚¹å’Œè¿çº¿
            const nodesWithCoords = [];
            const lines = []; // å­˜å‚¨è¿çº¿ä¿¡æ¯çš„å¯¹è±¡æ•°ç»„
            // é€’å½’å‡½æ•°ï¼šè®¡ç®—ä»¥ node ä¸ºæ ¹çš„å­æ ‘çš„å¸ƒå±€
            // è¿”å›è¯¥å­æ ‘çš„æ€»å®½åº¦
            function layoutSubtree(node, depth, startX) {
                node.y = depth * LEVEL_HEIGHT;
                // è®¡ç®—æ‰€æœ‰å­å­™èŠ‚ç‚¹çš„æ€»å®½åº¦
                let totalWidth = 0;
                if (node.childrenNodes.length > 0) {
                    // é€’å½’è®¡ç®—æ¯ä¸ªå­èŠ‚ç‚¹çš„å­æ ‘
                    let currentX = startX;
                    node.childrenNodes.forEach((child, index) => {
                        const childWidth = layoutSubtree(child, depth + 1, currentX);
                        totalWidth += childWidth;
                        currentX += childWidth + SIBLING_SPACING;
                    });
                    totalWidth += SIBLING_SPACING * (node.childrenNodes.length - 1);
                    // --- æ–°å¢/ä¿®æ”¹çš„è¿çº¿è®¡ç®—é€»è¾‘ ---
                    // 1. è®¡ç®—çˆ¶èŠ‚ç‚¹ä¸‹æ–¹çš„è¿æ¥ç‚¹ (å‚ç›´çº¿æœ«ç«¯)
                    const parentConnectorX = startX + (totalWidth - NODE_WIDTH) / 2 + NODE_WIDTH / 2; // çˆ¶èŠ‚ç‚¹æ°´å¹³ä¸­å¿ƒ
                    const parentConnectorY = node.y + NODE_HEIGHT; // çˆ¶èŠ‚ç‚¹åº•éƒ¨
                    // 2. è®¡ç®—ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå­èŠ‚ç‚¹çš„ä¸­å¿ƒ X åæ ‡ï¼Œç”¨äºç¡®å®šæ°´å¹³çº¿èŒƒå›´
                    const firstChildX = node.childrenNodes[0].x + NODE_WIDTH / 2;
                    const lastChildX = node.childrenNodes[node.childrenNodes.length - 1].x + NODE_WIDTH / 2;
                    // 3. æ·»åŠ çˆ¶èŠ‚ç‚¹åˆ°è¿æ¥ç‚¹çš„å‚ç›´çº¿
                    lines.push({
                        type: 'vertical',
                        x: parentConnectorX,
                        y1: parentConnectorY, // èµ·ç‚¹ï¼šçˆ¶èŠ‚ç‚¹åº•éƒ¨
                        y2: parentConnectorY + LEVEL_HEIGHT / 3 // ç»ˆç‚¹ï¼šå‘ä¸‹å»¶ä¼¸ä¸€æ®µè·ç¦»
                    });
                    // 4. æ·»åŠ è¿æ¥ç‚¹åˆ°å„å­èŠ‚ç‚¹çš„è¿çº¿ (å‚ç›´çº¿ + æ°´å¹³çº¿)
                    const connectorLineY = parentConnectorY + LEVEL_HEIGHT / 3; // æ°´å¹³çº¿æ‰€åœ¨çš„ Y åæ ‡
                    // æ·»åŠ æ°´å¹³çº¿
                    lines.push({
                        type: 'horizontal',
                        y: connectorLineY,
                        x1: firstChildX,
                        x2: lastChildX
                    });
                    // ä¸ºæ¯ä¸ªå­èŠ‚ç‚¹æ·»åŠ ä»æ°´å¹³çº¿åˆ°å­èŠ‚ç‚¹çš„å‚ç›´çŸ­çº¿
                    node.childrenNodes.forEach(child => {
                        const childConnectorX = child.x + NODE_WIDTH / 2;
                        lines.push({
                            type: 'vertical',
                            x: childConnectorX,
                            y1: connectorLineY, // èµ·ç‚¹ï¼šæ°´å¹³çº¿
                            y2: child.y          // ç»ˆç‚¹ï¼šå­èŠ‚ç‚¹é¡¶éƒ¨
                        });
                    });
                } else {
                    // å¶å­èŠ‚ç‚¹å®½åº¦å°±æ˜¯è‡ªèº«
                    totalWidth = NODE_WIDTH;
                }
                // èŠ‚ç‚¹çš„ x åæ ‡æ˜¯æ‰€æœ‰å­èŠ‚ç‚¹çš„ä¸­å¿ƒ (æˆ–è€…è‡ªèº«ä¸­å¿ƒ)
                node.x = startX + (totalWidth - NODE_WIDTH) / 2;
                nodesWithCoords.push(node);
                return totalWidth;
            }
            // ä»æ ¹èŠ‚ç‚¹å¼€å§‹å¸ƒå±€
            let currentX = 0;
            rootNodes.forEach(root => {
                const rootWidth = layoutSubtree(root, 0, currentX);
                currentX += rootWidth + 50; // æ ¹èŠ‚ç‚¹ä¹‹é—´çš„é—´è·
            });
            return { nodes: nodesWithCoords, lines: lines };
        }
        // è®¡ç®—ä»£æ•°å¸ƒå±€
        function calculateGenerationsLayout(nodesWithCoords) {
            const generations = {}; // { depth: [nodes] }
            // æŒ‰æ·±åº¦åˆ†ç»„èŠ‚ç‚¹
            nodesWithCoords.forEach(node => {
                const depth = Math.round(node.y / LEVEL_HEIGHT);
                if (!generations[depth]) {
                    generations[depth] = [];
                }
                generations[depth].push(node);
            });
            // è®¡ç®—æ¯ä¸€ä»£çš„Yåæ ‡èŒƒå›´
            const generationLayout = {}; // { depth: { minY, maxY, nodes } }
            Object.keys(generations).forEach(depth => {
                const nodes = generations[depth];
                const minY = Math.min(...nodes.map(n => n.y));
                const maxY = Math.max(...nodes.map(n => n.y + NODE_HEIGHT));
                generationLayout[depth] = { minY, maxY, nodes };
            });
            return generationLayout;
        }
        // æ¸²æŸ“æ—è°± (ä¼˜åŒ–ç‰ˆ - ä½¿ç”¨æ–°çš„è¿çº¿æ•°æ®)
        function renderFamilyTree() {
            const treeContent = document.getElementById('treeContent');
            const noData = document.getElementById('noData');
            if (familyTree.length === 0) {
                noData.style.display = 'block';
                treeContent.innerHTML = '';
                return;
            }
            noData.style.display = 'none';
            // è®¡ç®—å¸ƒå±€
            const layout = calculateLayout();
            const nodesWithCoords = layout.nodes;
            const lines = layout.lines;
            
            // è®¡ç®—ä»£æ•°å¸ƒå±€
            const generationLayout = calculateGenerationsLayout(nodesWithCoords);
            
            // æ¸…ç©ºå®¹å™¨
            treeContent.innerHTML = '';
            
            // ç»˜åˆ¶ä»£æ•°æ¡†å’Œè¿æ¥çº¿
            Object.keys(generationLayout).forEach(depth => {
                const genData = generationLayout[depth];
                const minY = genData.minY;
                const maxY = genData.maxY;
                
                // åˆ›å»ºä»£æ•°æ¡†
                const generationBox = document.createElement('div');
                generationBox.className = 'generation-box';
                generationBox.style.top = `${minY + (maxY - minY) / 2 - 25}px`; // å‚ç›´å±…ä¸­
                generationBox.setAttribute('data-depth', depth);
                
                // è·å–æˆ–åˆ›å»ºä»£æ•°ä¿¡æ¯
                if (!generationInfo[depth]) {
                    generationInfo[depth] = {
                        id: generateId(),
                        text: `ç¬¬${parseInt(depth) + 1}ä»£`
                    };
                }
                
                generationBox.innerHTML = `<span class="generation-text">${generationInfo[depth].text}</span>`;
                
                // æ·»åŠ ç‚¹å‡»ç¼–è¾‘äº‹ä»¶
                generationBox.onclick = function(e) {
                    e.stopPropagation();
                    editGenerationText(depth, generationBox);
                };
                
                treeContent.appendChild(generationBox);
                
                // ç»˜åˆ¶ä»£æ•°è¿æ¥çº¿ (å‚ç›´çº¿)
                const line = document.createElement('div');
                line.className = 'generation-line';
                line.style.left = '120px'; // ä»£æ•°æ¡†å³ä¾§ä½ç½®
                line.style.top = `${minY}px`;
                line.style.height = `${maxY - minY}px`;
                treeContent.appendChild(line);
            });
            
            // ç»˜åˆ¶è¿æ¥çº¿ (æ—è°±çº¿)
            lines.forEach(line => {
                const lineElement = document.createElement('div');
                lineElement.className = 'connector-line';
                if (line.type === 'vertical') {
                    lineElement.classList.add('vertical-line');
                    // å³ç§»æ—è°±çº¿ä»¥é¿å…ä¸ä»£æ•°æ¡†é‡å 
                    lineElement.style.left = `${line.x + 150}px`;
                    lineElement.style.top = `${line.y1}px`;
                    lineElement.style.height = `${Math.abs(line.y2 - line.y1)}px`;
                } else if (line.type === 'horizontal') {
                    lineElement.classList.add('horizontal-line');
                    lineElement.style.top = `${line.y}px`;
                    // å³ç§»æ—è°±çº¿ä»¥é¿å…ä¸ä»£æ•°æ¡†é‡å 
                    lineElement.style.left = `${line.x1 + 150}px`;
                    lineElement.style.width = `${Math.abs(line.x2 - line.x1)}px`;
                }
                treeContent.appendChild(lineElement);
            });
            
            // æ¸²æŸ“èŠ‚ç‚¹ (å³ç§»ä»¥é¿å…ä¸ä»£æ•°æ¡†é‡å )
            nodesWithCoords.forEach(person => {
                const node = createNodeElement(person);
                node.style.left = `${person.x + 150}px`; // å³ç§»150px
                node.style.top = `${person.y}px`;
                treeContent.appendChild(node);
            });
        }
        // ç¼–è¾‘ä»£æ•°æ–‡æœ¬
        function editGenerationText(depth, boxElement) {
            const textElement = boxElement.querySelector('.generation-text');
            const currentText = generationInfo[depth].text;
            
            // åˆ›å»ºè¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            
            // æ¸…ç©ºå¹¶æ·»åŠ è¾“å…¥æ¡†
            boxElement.innerHTML = '';
            boxElement.appendChild(input);
            boxElement.classList.add('generation-box-editing');
            
            // èšç„¦å¹¶å…¨é€‰
            input.focus();
            input.select();
            
            // å¤„ç†å®Œæˆç¼–è¾‘
            function finishEdit() {
                const newText = input.value.trim() || `ç¬¬${parseInt(depth) + 1}ä»£`;
                generationInfo[depth].text = newText;
                
                // æ›´æ–°æ˜¾ç¤º
                boxElement.innerHTML = `<span class="generation-text">${newText}</span>`;
                boxElement.classList.remove('generation-box-editing');
                
                // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                boxElement.onclick = function(e) {
                    e.stopPropagation();
                    editGenerationText(depth, boxElement);
                };
            }
            
            // ç›‘å¬å›è½¦å’Œå¤±ç„¦
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    finishEdit();
                }
            });
            
            input.addEventListener('blur', finishEdit);
        }
        // åˆ›å»ºèŠ‚ç‚¹å…ƒç´ 
        function createNodeElement(person) {
            const node = document.createElement('div');
            node.className = `node ${person.gender}`;
            let nodeContent = `<div>${person.name}</div>`;
            nodeContent += `<div style="font-size: 12px; margin-top: 4px;">${person.gender === 'male' ? 'ç”·' : 'å¥³'}</div>`;
            if (person.spouseName) {
                 nodeContent += `<div class="spouse-name">(${person.spouseName})</div>`;
            }
            node.innerHTML = nodeContent;
            // å·¦é”®ç‚¹å‡»é€‰æ‹©èŠ‚ç‚¹
            node.onclick = (e) => {
                e.stopPropagation();
                selectPerson(person);
            };
            // å³é”®ç‚¹å‡»ä¹Ÿé€‰æ‹©èŠ‚ç‚¹å¹¶æ˜¾ç¤ºèœå•
            node.oncontextmenu = (e) => {
                e.preventDefault();
                e.stopPropagation();
                selectPerson(person);
                showContextMenu(e, person);
            };
            return node;
        }
        // æ˜¾ç¤ºå³é”®èœå•
        function showContextMenu(event, person) {
            contextMenuPerson = person;
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            contextMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            }, { once: true });
        }
        // é€‰æ‹©äººå‘˜
        function selectPerson(person) {
            const prevSelected = document.querySelector('.node.selected');
            if (prevSelected) {
                prevSelected.classList.remove('selected');
            }
            const allNodes = document.querySelectorAll('.node');
            allNodes.forEach(node => {
                const nodeText = node.textContent.trim();
                if (nodeText.includes(person.name)) {
                     node.classList.add('selected');
                }
            });
            selectedPerson = person;
            renderPersonInfo(person);
        }
        // æ¸²æŸ“äººå‘˜ä¿¡æ¯ (åŒ…å«å¤šåª’ä½“ç®¡ç†)
        function renderPersonInfo(person) {
            const infoContent = document.getElementById('personInfo');
            const birthDate = person.birthDate ? new Date(person.birthDate).toLocaleDateString('zh-CN') : 'æœªå¡«å†™';
            const deathDate = person.deathDate ? new Date(person.deathDate).toLocaleDateString('zh-CN') : 'æœªå¡«å†™';
            const avatarHtml = person.avatarUrl ?
                `<img src="${person.avatarUrl}" alt="å¤´åƒ" class="avatar" id="personAvatar">` :
                `<div class="avatar-placeholder" id="personAvatarPlaceholder">${person.gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'}</div>`;
            // ç”Ÿæˆå¤šåª’ä½“HTML
            const biographyHtml = generateEntryHtml(person.biography, 'biography', 'ç”Ÿå¹³ä»‹ç»');
            const afterlifeHtml = generateEntryHtml(person.afterlife, 'afterlife', 'èº«åäº‹');
            const graveHtml = generateEntryHtml(person.graveLocation, 'graveLocation', 'å¢“åœ°');
            infoContent.innerHTML = `
                <div class="avatar-container">
                    ${avatarHtml}
                    <div class="avatar-actions">
                        <button class="btn btn-primary btn-small avatar-btn" onclick="triggerAvatarUpload()">ä¸Šä¼ å¤´åƒ</button>
                        ${person.avatarUrl ? `<button class="btn btn-warning btn-small avatar-btn" onclick="replaceAvatar()">æ›¿æ¢</button>
                        <button class="btn btn-danger btn-small avatar-btn" onclick="deleteAvatar()">åˆ é™¤</button>` : ''}
                    </div>
                </div>
                <div class="info-item">
                    <span class="info-label">å§“å:</span>
                    <span class="info-value">${person.name}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ€§åˆ«:</span>
                    <span class="info-value">${person.gender === 'male' ? 'ç”·' : 'å¥³'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é…å¶:</span>
                    <span class="info-value">${person.spouseName || 'æœªå¡«å†™'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ°‘æ—:</span>
                    <span class="info-value">${person.ethnicity || 'æœªå¡«å†™'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å‡ºç”Ÿæ—¥æœŸ:</span>
                    <span class="info-value">${birthDate}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å»ä¸–æ—¥æœŸ:</span>
                    <span class="info-value">${deathDate}</span>
                </div>
                <div class="info-item">
                    <div><span class="info-label">ç”Ÿå¹³ä»‹ç»:</span></div>
                    <div class="media-container">
                        ${biographyHtml}
                        <button class="btn btn-primary btn-small add-entry-btn" onclick="addNewEntry('biography')">æ·»åŠ æ¡ç›®</button>
                    </div>
                </div>
                <div class="info-item">
                    <div><span class="info-label">èº«åäº‹:</span></div>
                    <div class="media-container">
                        ${afterlifeHtml}
                        <button class="btn btn-primary btn-small add-entry-btn" onclick="addNewEntry('afterlife')">æ·»åŠ æ¡ç›®</button>
                    </div>
                </div>
                <div class="info-item">
                    <div><span class="info-label">å¢“åœ°:</span></div>
                    <div class="media-container">
                        ${graveHtml}
                        <button class="btn btn-primary btn-small add-entry-btn" onclick="addNewEntry('graveLocation')">æ·»åŠ æ¡ç›®</button>
                    </div>
                </div>
                <div class="info-item">
                    <div><span class="info-label">ç”µå­é™µå¢“ç©ºé—´:</span></div>
                    <div>
                        <button class="btn btn-info btn-small space-btn" onclick="enterTombSpace()">è¿›å…¥ç©ºé—´</button>
                    </div>
                </div>
                <div class="info-item">
                    <div><span class="info-label">è™šæ‹Ÿä¸–ç•Œ:</span></div>
                    <div>
                        <button class="btn btn-info btn-small space-btn" onclick="enterVirtualWorld()">è¿›å…¥ç©ºé—´</button>
                    </div>
                </div>
                <div class="add-node-form">
                    <h3 style="margin-bottom: 15px; color: #333;">æ“ä½œ</h3>
                    <button class="btn btn-primary btn-small" onclick="showAddChildModal()" style="margin-right: 10px;">æ·»åŠ å­èŠ‚ç‚¹</button>
                    <button class="btn btn-secondary btn-small" onclick="showEditModal()">ç¼–è¾‘ä¿¡æ¯</button>
                </div>
            `;
        }
        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®å­—æ®µå†…å®¹ç”ŸæˆåŒ…å«æ¡ç›®çš„HTML
        function generateEntryHtml(entries, fieldName, fieldTitle) {
            if (!entries || entries.length === 0) {
                return '<div class="info-value">æš‚æ— æ¡ç›®</div>';
            }
            let html = '';
            entries.forEach((entry, index) => {
                html += `<div class="entry-container" data-id="${entry.id}">`;
                html += `<div class="entry-header">`;
                html += `<input type="text" class="entry-title-input" value="${entry.title || ''}" placeholder="è¯·è¾“å…¥æ ‡é¢˜" onchange="updateEntryTitle('${fieldName}', '${entry.id}', this.value)">`;
                html += `<div class="entry-actions">`;
                html += `<button class="btn btn-danger btn-small media-btn" onclick="deleteEntry('${fieldName}', '${entry.id}')">åˆ é™¤</button>`;
                html += `</div>`;
                html += `</div>`;
                html += `<div class="entry-content">`;
                html += `<textarea class="entry-text-input" placeholder="è¯·è¾“å…¥æ–‡å­—å†…å®¹" onchange="updateEntryText('${fieldName}', '${entry.id}', this.value)">${entry.text || ''}</textarea>`;
                html += `<div class="media-actions" style="margin-top: 8px;">`;
                html += `<button class="btn btn-primary btn-small media-btn" onclick="triggerMediaUpload('${fieldName}', '${entry.id}', 'add')">æ·»åŠ å›¾ç‰‡/éŸ³è§†é¢‘</button>`;
                html += `</div>`;
                if (entry.media && entry.media.length > 0) {
                    html += `<div class="entry-media-preview">`;
                    entry.media.forEach(mediaItem => {
                        if (mediaItem.type === 'image') {
                            html += `<img src="${mediaItem.content}" alt="å›¾ç‰‡" class="media-preview">`;
                        } else if (mediaItem.type === 'video') {
                            html += `<div class="video-container"><video controls><source src="${mediaItem.content}" type="video/mp4">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚</video></div>`;
                        } else if (mediaItem.type === 'audio') {
                            html += `<div class="audio-container"><audio controls src="${mediaItem.content}">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚</audio></div>`;
                        }
                        html += `
                            <div class="media-actions" style="margin-top: 5px;">
                                <button class="btn btn-warning btn-small media-btn" onclick="triggerMediaUpload('${fieldName}', '${entry.id}', 'replace', '${mediaItem.id}')">æ›¿æ¢</button>
                                <button class="btn btn-danger btn-small media-btn" onclick="deleteMediaItem('${fieldName}', '${entry.id}', '${mediaItem.id}')">åˆ é™¤</button>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
                html += `</div>`;
                html += '</div>';
            });
            return html;
        }
        // æ·»åŠ æ–°æ¡ç›®
        function addNewEntry(fieldName) {
            if (!selectedPerson) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            if (!selectedPerson[fieldName]) {
                selectedPerson[fieldName] = [];
            }
            const newEntry = {
                id: generateId(),
                title: '',
                text: '',
                media: []
            };
            selectedPerson[fieldName].push(newEntry);
            renderPersonInfo(selectedPerson);
        }
        // æ›´æ–°æ¡ç›®æ ‡é¢˜
        function updateEntryTitle(fieldName, entryId, title) {
            if (!selectedPerson) return;
            if (selectedPerson[fieldName] && Array.isArray(selectedPerson[fieldName])) {
                const entry = selectedPerson[fieldName].find(e => e.id === entryId);
                if (entry) {
                    entry.title = title;
                }
            }
        }
        // æ›´æ–°æ¡ç›®æ–‡å­—
        function updateEntryText(fieldName, entryId, text) {
            if (!selectedPerson) return;
            if (selectedPerson[fieldName] && Array.isArray(selectedPerson[fieldName])) {
                const entry = selectedPerson[fieldName].find(e => e.id === entryId);
                if (entry) {
                    entry.text = text;
                }
            }
        }
        // åˆ é™¤æ¡ç›®
        function deleteEntry(fieldName, entryId) {
            if (!selectedPerson) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ¡ç›®å—ï¼Ÿ')) {
                if (selectedPerson[fieldName] && Array.isArray(selectedPerson[fieldName])) {
                    const index = selectedPerson[fieldName].findIndex(entry => entry.id === entryId);
                    if (index !== -1) {
                        selectedPerson[fieldName].splice(index, 1);
                        renderPersonInfo(selectedPerson);
                    }
                }
            }
        }
        // è§¦å‘å¤´åƒä¸Šä¼ 
        function triggerAvatarUpload() {
            if (!selectedPerson) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            document.getElementById('avatarInput').click();
        }
        // å¤„ç†å¤´åƒä¸Šä¼ 
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file || !selectedPerson) return;
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedPerson.avatarUrl = e.target.result;
                renderPersonInfo(selectedPerson);
                renderFamilyTree();
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }
        // æ›¿æ¢å¤´åƒ
        function replaceAvatar() {
            triggerAvatarUpload();
        }
        // åˆ é™¤å¤´åƒ
        function deleteAvatar() {
            if (!selectedPerson) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            if (confirm('ç¡®å®šè¦åˆ é™¤å¤´åƒå—ï¼Ÿ')) {
                delete selectedPerson.avatarUrl;
                renderPersonInfo(selectedPerson);
                renderFamilyTree();
            }
        }
        // è§¦å‘å¤šåª’ä½“ä¸Šä¼ 
        function triggerMediaUpload(fieldName, entryId, action, mediaItemId = null) {
            if (!selectedPerson) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            currentMediaField = fieldName;
            currentEntryId = entryId;
            currentMediaAction = action;
            currentMediaItemId = mediaItemId; // ä»…åœ¨æ›¿æ¢æ—¶æœ‰å€¼
            document.getElementById('mediaInput').click();
        }
        // å¤„ç†å¤šåª’ä½“ä¸Šä¼ 
        function handleMediaUpload(event) {
            const file = event.target.files[0];
            if (!file || !selectedPerson || !currentMediaField || !currentEntryId) return;
            const fieldName = currentMediaField;
            const entryId = currentEntryId;
            const action = currentMediaAction;
            const mediaItemId = currentMediaItemId;
            const reader = new FileReader();
            reader.onload = function(e) {
                const fileDataUrl = e.target.result;
                // ç¡®ä¿å­—æ®µå­˜åœ¨ä¸”ä¸ºæ•°ç»„
                if (!selectedPerson[fieldName]) {
                    selectedPerson[fieldName] = [];
                } else if (!Array.isArray(selectedPerson[fieldName])) {
                    // å¦‚æœä¹‹å‰æ˜¯å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸ºæ•°ç»„
                    selectedPerson[fieldName] = [{ id: generateId(), title: '', text: selectedPerson[fieldName], media: [] }];
                }
                // æ‰¾åˆ°å¯¹åº”çš„æ¡ç›®
                const entry = selectedPerson[fieldName].find(e => e.id === entryId);
                if (entry) {
                    // åˆ›å»ºæ–°çš„åª’ä½“é¡¹
                    let newItem = null;
                    if (file.type.startsWith('image/')) {
                        newItem = { id: generateId(), type: 'image', content: fileDataUrl };
                    } else if (file.type.startsWith('video/')) {
                        newItem = { id: generateId(), type: 'video', content: fileDataUrl };
                    } else if (file.type.startsWith('audio/')) {
                        newItem = { id: generateId(), type: 'audio', content: fileDataUrl };
                    } else {
                        alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼');
                        return;
                    }
                    if (!entry.media) {
                        entry.media = [];
                    }
                    if (action === 'replace' && mediaItemId) {
                        // æ›¿æ¢ç°æœ‰é¡¹
                        const index = entry.media.findIndex(item => item.id === mediaItemId);
                        if (index !== -1) {
                            entry.media[index] = newItem;
                        }
                    } else {
                        // æ·»åŠ æ–°é¡¹
                        entry.media.push(newItem);
                    }
                    renderPersonInfo(selectedPerson);
                    renderFamilyTree();
                }
            };
            if (file.type.startsWith('image/') || file.type.startsWith('video/') || file.type.startsWith('audio/')) {
                reader.readAsDataURL(file);
            } else {
                alert('è¯·é€‰æ‹©å›¾ç‰‡ã€è§†é¢‘æˆ–éŸ³é¢‘æ–‡ä»¶ï¼');
            }
            event.target.value = '';
            currentMediaField = null;
            currentEntryId = null;
            currentMediaAction = null;
            currentMediaItemId = null;
        }
        // åˆ é™¤å¤šåª’ä½“é¡¹
        function deleteMediaItem(fieldName, entryId, mediaItemId) {
            if (!selectedPerson) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤é¡¹å†…å®¹å—ï¼Ÿ')) {
                if (selectedPerson[fieldName] && Array.isArray(selectedPerson[fieldName])) {
                    const entry = selectedPerson[fieldName].find(e => e.id === entryId);
                    if (entry && entry.media && Array.isArray(entry.media)) {
                        const index = entry.media.findIndex(item => item.id === mediaItemId);
                        if (index !== -1) {
                            entry.media.splice(index, 1);
                            renderPersonInfo(selectedPerson);
                        }
                    }
                }
            }
        }
        // è¿›å…¥ç”µå­é™µå¢“ç©ºé—´
        function enterTombSpace() {
            if (!selectedPerson) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            alert(`è¿›å…¥ ${selectedPerson.name} çš„ç”µå­é™µå¢“ç©ºé—´`);
            // è¿™é‡Œå¯ä»¥æ·»åŠ è¿›å…¥ç”µå­é™µå¢“ç©ºé—´çš„å…·ä½“é€»è¾‘
        }
        // è¿›å…¥è™šæ‹Ÿä¸–ç•Œ
        function enterVirtualWorld() {
            if (!selectedPerson) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            alert(`è¿›å…¥ ${selectedPerson.name} çš„è™šæ‹Ÿä¸–ç•Œ`);
            // è¿™é‡Œå¯ä»¥æ·»åŠ è¿›å…¥è™šæ‹Ÿä¸–ç•Œçš„å…·ä½“é€»è¾‘
        }
        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        // æ˜¾ç¤ºæ·»åŠ æ ¹èŠ‚ç‚¹æ¨¡æ€æ¡†
        function showAddRootModal() {
            document.getElementById('addRootModal').style.display = 'block';
            document.getElementById('rootName').value = '';
            document.getElementById('rootGender').value = 'male';
            document.getElementById('rootSpouseName').value = '';
            document.getElementById('rootEthnicity').value = '';
            document.getElementById('rootBirthDate').value = '';
            document.getElementById('rootDeathDate').value = '';
            // ä¸å†éœ€è¦åˆå§‹åŒ–è¢«ç§»é™¤çš„å­—æ®µ
        }
        // æ˜¾ç¤ºæ·»åŠ çˆ¶èŠ‚ç‚¹æ¨¡æ€æ¡†
        function showAddParentModal() {
            if (!contextMenuPerson) {
                alert('è¯·å³é”®ç‚¹å‡»ä¸€ä¸ªèŠ‚ç‚¹ï¼');
                return;
            }
            document.getElementById('addParentModal').style.display = 'block';
            document.getElementById('parentName').value = '';
            document.getElementById('parentGender').value = 'male';
            document.getElementById('parentSpouseName').value = '';
            document.getElementById('parentEthnicity').value = '';
            document.getElementById('parentBirthDate').value = '';
            document.getElementById('parentDeathDate').value = '';
            // ä¸å†éœ€è¦åˆå§‹åŒ–è¢«ç§»é™¤çš„å­—æ®µ
        }
        // æ˜¾ç¤ºæ·»åŠ å­èŠ‚ç‚¹æ¨¡æ€æ¡†
        function showAddChildModal() {
            if (!selectedPerson && !contextMenuPerson) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            const person = selectedPerson || contextMenuPerson;
            document.getElementById('addChildModal').style.display = 'block';
            document.getElementById('childName').value = '';
            document.getElementById('childGender').value = 'male';
            document.getElementById('childSpouseName').value = '';
            document.getElementById('childEthnicity').value = '';
            document.getElementById('childBirthDate').value = '';
            document.getElementById('childDeathDate').value = '';
        }
        // æ˜¾ç¤ºæ·»åŠ é…å¶æ¨¡æ€æ¡†
        function showAddSpouseModal() {
            if (!selectedPerson && !contextMenuPerson) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            const person = selectedPerson || contextMenuPerson;
            document.getElementById('addSpouseModal').style.display = 'block';
            document.getElementById('spouseName').value = '';
            document.getElementById('spouseGender').value = 'female';
            if (person.gender === 'male') {
                document.getElementById('spouseGender').value = 'female';
            } else {
                document.getElementById('spouseGender').value = 'male';
            }
            document.getElementById('spouseEthnicity').value = '';
            document.getElementById('spouseBirthDate').value = '';
            document.getElementById('spouseDeathDate').value = '';
            document.getElementById('spouseBiography').value = '';
            document.getElementById('spouseAfterlife').value = '';
            document.getElementById('spouseGraveLocation').value = '';
        }
        // æ˜¾ç¤ºç¼–è¾‘èŠ‚ç‚¹æ¨¡æ€æ¡†
        function showEditModal() {
            if (!selectedPerson && !contextMenuPerson) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            const person = selectedPerson || contextMenuPerson;
            document.getElementById('editModal').style.display = 'block';
            document.getElementById('editName').value = person.name;
            document.getElementById('editGender').value = person.gender;
            document.getElementById('editSpouseName').value = person.spouseName || '';
            document.getElementById('editEthnicity').value = person.ethnicity || '';
            document.getElementById('editBirthDate').value = person.birthDate || '';
            document.getElementById('editDeathDate').value = person.deathDate || '';
        }
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        // æ·»åŠ æ ¹èŠ‚ç‚¹ (ç²¾ç®€ç‰ˆ)
        function addRootNode() {
            const name = document.getElementById('rootName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥å§“åï¼');
                return;
            }
            // ä¸å†å¤„ç†è¢«ç§»é™¤çš„å­—æ®µ
            const rootNode = {
                id: nextId++,
                name: name,
                gender: document.getElementById('rootGender').value,
                spouseName: document.getElementById('rootSpouseName').value.trim(),
                ethnicity: document.getElementById('rootEthnicity').value.trim(),
                birthDate: document.getElementById('rootBirthDate').value,
                deathDate: document.getElementById('rootDeathDate').value,
                // ç²¾ç®€ç‰ˆä¸åŒ…å«è¿™äº›å­—æ®µ
                biography: [],
                afterlife: [],
                graveLocation: [],
                parentId: null,
                children: []
            };
            familyTree.push(rootNode);
            renderFamilyTree();
            closeModal('addRootModal');
        }
        // æ·»åŠ çˆ¶èŠ‚ç‚¹ (ç²¾ç®€ç‰ˆ)
        function addParentNode() {
            if (!contextMenuPerson) {
                alert('è¯·å³é”®ç‚¹å‡»ä¸€ä¸ªèŠ‚ç‚¹ï¼');
                return;
            }
            const name = document.getElementById('parentName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥å§“åï¼');
                return;
            }
            const parentNode = {
                id: nextId++,
                name: name,
                gender: document.getElementById('parentGender').value,
                spouseName: document.getElementById('parentSpouseName').value.trim(),
                ethnicity: document.getElementById('parentEthnicity').value.trim(),
                birthDate: document.getElementById('parentBirthDate').value,
                deathDate: document.getElementById('parentDeathDate').value,
                // ç²¾ç®€ç‰ˆä¸åŒ…å«è¿™äº›å­—æ®µ
                biography: [],
                afterlife: [],
                graveLocation: [],
                parentId: null,
                children: [contextMenuPerson.id]
            };
            contextMenuPerson.parentId = parentNode.id;
            familyTree.push(parentNode);
            renderFamilyTree();
            closeModal('addParentModal');
            document.getElementById('contextMenu').style.display = 'none';
        }
        // æ·»åŠ å­èŠ‚ç‚¹ (ç²¾ç®€ç‰ˆ)
        function addChildNode() {
            const person = selectedPerson || contextMenuPerson;
            if (!person) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            const name = document.getElementById('childName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥å§“åï¼');
                return;
            }
            const childNode = {
                id: nextId++,
                name: name,
                gender: document.getElementById('childGender').value,
                spouseName: document.getElementById('childSpouseName').value.trim(),
                ethnicity: document.getElementById('childEthnicity').value.trim(),
                birthDate: document.getElementById('childBirthDate').value,
                deathDate: document.getElementById('childDeathDate').value,
                // ç²¾ç®€ç‰ˆä¸åŒ…å«è¿™äº›å­—æ®µ
                biography: [],
                afterlife: [],
                graveLocation: [],
                parentId: person.id,
                children: []
            };
            familyTree.push(childNode);
            renderFamilyTree();
            closeModal('addChildModal');
            document.getElementById('contextMenu').style.display = 'none';
        }
        // æ·»åŠ é…å¶èŠ‚ç‚¹ (å®Œæ•´ç‰ˆ)
        function addSpouseNode() {
            const person = selectedPerson || contextMenuPerson;
            if (!person) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            const name = document.getElementById('spouseName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥å§“åï¼');
                return;
            }
            const biographyText = document.getElementById('spouseBiography').value.trim();
            const afterlifeText = document.getElementById('spouseAfterlife').value.trim();
            const graveLocationText = document.getElementById('spouseGraveLocation').value.trim();
            const spouseNode = {
                id: nextId++,
                name: name,
                gender: document.getElementById('spouseGender').value,
                ethnicity: document.getElementById('spouseEthnicity').value.trim(),
                birthDate: document.getElementById('spouseBirthDate').value,
                deathDate: document.getElementById('spouseDeathDate').value,
                biography: biographyText ? [{ id: generateId(), title: '', text: biographyText, media: [] }] : [],
                afterlife: afterlifeText ? [{ id: generateId(), title: '', text: afterlifeText, media: [] }] : [],
                graveLocation: graveLocationText ? [{ id: generateId(), title: '', text: graveLocationText, media: [] }] : [],
                parentId: null,
                children: []
            };
            familyTree.push(spouseNode);
            person.spouseName = name;
            renderFamilyTree();
            if (selectedPerson) {
                renderPersonInfo(selectedPerson);
            }
            closeModal('addSpouseModal');
            document.getElementById('contextMenu').style.display = 'none';
        }
        // ç¼–è¾‘èŠ‚ç‚¹ (ç²¾ç®€ç‰ˆ)
        function editNode() {
            const person = selectedPerson || contextMenuPerson;
            if (!person) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäººå‘˜ï¼');
                return;
            }
            const name = document.getElementById('editName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥å§“åï¼');
                return;
            }
            person.name = name;
            person.gender = document.getElementById('editGender').value;
            person.spouseName = document.getElementById('editSpouseName').value.trim();
            person.ethnicity = document.getElementById('editEthnicity').value.trim();
            person.birthDate = document.getElementById('editBirthDate').value;
            person.deathDate = document.getElementById('editDeathDate').value;
            // ç²¾ç®€ç‰ˆä¸å¤„ç† biography, afterlife, graveLocation å­—æ®µçš„ç¼–è¾‘
            renderFamilyTree();
            if (selectedPerson) {
                renderPersonInfo(selectedPerson);
            }
            closeModal('editModal');
            document.getElementById('contextMenu').style.display = 'none';
        }
        // åˆ é™¤èŠ‚ç‚¹
        function deleteNode() {
            if (!contextMenuPerson) {
                alert('è¯·å³é”®ç‚¹å‡»ä¸€ä¸ªèŠ‚ç‚¹ï¼');
                return;
            }
            if (confirm(`ç¡®å®šè¦åˆ é™¤ "${contextMenuPerson.name}" å«å…¶æ‰€æœ‰åä»£å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                function deleteNodeAndChildren(nodeId) {
                    const node = familyTree.find(p => p.id === nodeId);
                    if (node) {
                        if (node.children && node.children.length > 0) {
                            node.children.forEach(childId => {
                                deleteNodeAndChildren(childId);
                            });
                        }
                        const index = familyTree.findIndex(p => p.id === nodeId);
                        if (index !== -1) {
                            familyTree.splice(index, 1);
                        }
                    }
                }
                deleteNodeAndChildren(contextMenuPerson.id);
                if (selectedPerson && selectedPerson.id === contextMenuPerson.id) {
                    selectedPerson = null;
                    document.getElementById('personInfo').innerHTML = '<div class="no-data">è¯·é€‰æ‹©æ—è°±ä¸­çš„äººå‘˜æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>';
                }
                renderFamilyTree();
            }
            document.getElementById('contextMenu').style.display = 'none';
        }
        // æ¸…é™¤æ—è°±
        function clearFamilyTree() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ•´ä¸ªæ—è°±å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                familyTree = [];
                selectedPerson = null;
                generationInfo = {}; // åŒæ—¶æ¸…é™¤ä»£æ•°ä¿¡æ¯
                renderFamilyTree();
                document.getElementById('personInfo').innerHTML = '<div class="no-data">è¯·é€‰æ‹©æ—è°±ä¸­çš„äººå‘˜æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>';
            }
        }
        // ä¿å­˜æ—è°±åˆ°æœ¬åœ°å­˜å‚¨
        function saveFamilyTree() {
            if (familyTree.length === 0) {
                alert('æ—è°±ä¸ºç©ºï¼Œæ— éœ€ä¿å­˜ï¼');
                return;
            }
            try {
                const dataToSave = {
                    familyTree: familyTree,
                    generationInfo: generationInfo
                };
                localStorage.setItem('familyTreeData', JSON.stringify(dataToSave));
                alert('æ—è°±ä¿å­˜æˆåŠŸï¼');
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + e.message);
            }
        }
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ—è°±
        function loadFamilyTreeFromStorage() {
            try {
                const savedData = localStorage.getItem('familyTreeData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    familyTree = parsedData.familyTree || [];
                    generationInfo = parsedData.generationInfo || {};
                    nextId = Math.max(...familyTree.map(p => p.id), 0) + 1;
                    renderFamilyTree();
                    alert('æ—è°±åŠ è½½æˆåŠŸï¼');
                } else {
                    alert('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ—è°±æ•°æ®ï¼');
                }
            } catch (e) {
                alert('åŠ è½½å¤±è´¥ï¼š' + e.message);
            }
        }
        // å¯¼å‡ºæ—è°±ä¸ºZIPæ–‡ä»¶
        async function exportFamilyTree() {
            if (familyTree.length === 0) {
                alert('æ—è°±ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡ºï¼');
                return;
            }
            try {
                // 1. åˆ›å»ºä¸€ä¸ªæ–°çš„ JSZip å®ä¾‹
                const zip = new JSZip();
                // 2. å‡†å¤‡æ—è°±æ•°æ® JSON
                const exportData = {
                    familyTree: familyTree.map(person => {
                        // åˆ›å»ºä¸€ä¸ªä¸åŒ…å«å¤šåª’ä½“å†…å®¹çš„å‰¯æœ¬
                        const personData = {...person};
                        // ç§»é™¤å¤´åƒ URL ä»¥é¿å…æ··æ·†ï¼ˆå› ä¸ºæˆ‘ä»¬å°†åœ¨ zip ä¸­å•ç‹¬å­˜å‚¨æ–‡ä»¶ï¼‰
                        // delete personData.avatarUrl;
                        // å¯ä»¥é€‰æ‹©ä¿ç•™ URLï¼Œæˆ–è€…åœ¨å¯¼å…¥æ—¶é‡æ–°æ„å»º
                        return personData;
                    }),
                    generationInfo: generationInfo
                };
                // 3. å°†æ—è°±æ•°æ®æ·»åŠ åˆ° zip
                zip.file("familyTree.json", JSON.stringify(exportData, null, 2));
                // 4. æ”¶é›†æ‰€æœ‰éœ€è¦å­˜å‚¨çš„åª’ä½“æ–‡ä»¶ (Base64 Data URLs)
                const mediaFilesToInclude = new Set(); // ä½¿ç”¨ Set é¿å…é‡å¤
                familyTree.forEach(person => {
                    // å¤´åƒ
                    if (person.avatarUrl && person.avatarUrl.startsWith('data:')) {
                         // ä» Data URL æå– Base64 æ•°æ®å’Œæ–‡ä»¶æ‰©å±•å
                        const matches = person.avatarUrl.match(/^data:image\/([a-zA-Z+]+);base64,(.+)$/);
                        if (matches && matches[2]) {
                            const ext = matches[1] === 'jpeg' ? 'jpg' : matches[1]; // æ ‡å‡†åŒ– jpg
                            const base64Data = matches[2];
                            const filename = `media/avatar_${person.id}.${ext}`;
                            mediaFilesToInclude.add({filename, base64Data});
                            // æ›´æ–° JSON ä¸­çš„å¼•ç”¨ä¸ºç›¸å¯¹è·¯å¾„
                            person.avatarUrl = filename;
                        }
                    }
                    // æ¡ç›®ä¸­çš„åª’ä½“
                    ['biography', 'afterlife', 'graveLocation'].forEach(field => {
                        if (person[field] && Array.isArray(person[field])) {
                            person[field].forEach(entry => {
                                if (entry.media && Array.isArray(entry.media)) {
                                    entry.media.forEach(mediaItem => {
                                        if (mediaItem.content && mediaItem.content.startsWith('data:')) {
                                            let ext = 'bin'; // é»˜è®¤æ‰©å±•å
                                            let base64Data = '';
                                            if (mediaItem.type === 'image') {
                                                const matches = mediaItem.content.match(/^data:image\/([a-zA-Z+]+);base64,(.+)$/);
                                                if (matches) {
                                                    ext = matches[1] === 'jpeg' ? 'jpg' : matches[1];
                                                    base64Data = matches[2];
                                                }
                                            } else if (mediaItem.type === 'video') {
                                                const matches = mediaItem.content.match(/^data:video\/([a-zA-Z0-9+.-]+);base64,(.+)$/);
                                                if (matches) {
                                                    // ç®€åŒ–æ‰©å±•åï¼Œå®é™…å¯èƒ½éœ€è¦æ›´å¤æ‚çš„æ˜ å°„
                                                    ext = matches[1].split('/')[0] || 'mp4';
                                                    base64Data = matches[2];
                                                }
                                            } else if (mediaItem.type === 'audio') {
                                                const matches = mediaItem.content.match(/^data:audio\/([a-zA-Z0-9+.-]+);base64,(.+)$/);
                                                if (matches) {
                                                    ext = matches[1].split('/')[0] || 'mp3';
                                                    base64Data = matches[2];
                                                }
                                            }
                                            if (base64Data) {
                                                const filename = `media/${field}_${entry.id}_${mediaItem.id}.${ext}`;
                                                mediaFilesToInclude.add({filename, base64Data});
                                                // æ›´æ–° JSON ä¸­çš„å¼•ç”¨ä¸ºç›¸å¯¹è·¯å¾„
                                                mediaItem.content = filename;
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });
                });
                // 5. å°†æ”¶é›†åˆ°çš„åª’ä½“æ–‡ä»¶æ·»åŠ åˆ° zip
                mediaFilesToInclude.forEach(fileObj => {
                    zip.file(fileObj.filename, fileObj.base64Data, {base64: true});
                });
                // 6. ç”Ÿæˆ zip æ–‡ä»¶å¹¶è§¦å‘ä¸‹è½½
                const content = await zip.generateAsync({type: "blob"});
                const url = URL.createObjectURL(content);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'æ—è°±æ•°æ®.zip';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alert('æ—è°±å¯¼å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error("å¯¼å‡ºå¤±è´¥:", error);
                alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
            }
        }
        // å¯¼å…¥æ—è°±
        function importFamilyTree() {
            // æ˜¾ç¤ºå¯¼å…¥æç¤º
            const hint = document.createElement('div');
            hint.className = 'import-hint';
            hint.innerHTML = `
                <p><strong>å¯¼å…¥è¯´æ˜ï¼š</strong></p>
                <p>è¯·ä¸Šä¼ é€šè¿‡æœ¬ç³»ç»Ÿ<strong>å¯¼å‡º</strong>çš„ <strong>.zip</strong> æ–‡ä»¶ã€‚</p>
                <p>è¯¥æ–‡ä»¶åº”åŒ…å«æ—è°±æ•°æ® (familyTree.json) å’Œç›¸å…³çš„å¤šåª’ä½“æ–‡ä»¶ã€‚</p>
            `;
            // å°†æç¤ºæ’å…¥åˆ°å¯¼å…¥æŒ‰é’®æ—è¾¹æˆ–ä¸‹æ–¹
            const importBtn = document.querySelector('.btn-warning[onclick="importFamilyTree()"]');
            if (importBtn) {
                importBtn.parentNode.insertBefore(hint, importBtn.nextSibling);
                // å‡ ç§’åè‡ªåŠ¨ç§»é™¤æç¤º
                setTimeout(() => {
                    if (hint.parentNode) {
                        hint.parentNode.removeChild(hint);
                    }
                }, 10000); // 10ç§’åç§»é™¤
            }
            document.getElementById('fileInput').click();
        }
        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.name.endsWith('.zip')) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ª .zip æ–‡ä»¶!');
                event.target.value = ''; // æ¸…ç©º input
                return;
            }
            try {
                // 1. ä½¿ç”¨ JSZip è¯»å–æ–‡ä»¶
                const zip = new JSZip();
                const zipContent = await zip.loadAsync(file);
                // 2. è¯»å–æ—è°±æ•°æ® JSON
                const jsonDataFile = zipContent.file("familyTree.json");
                if (!jsonDataFile) {
                    throw new Error('ZIP æ–‡ä»¶ä¸­æœªæ‰¾åˆ° familyTree.json');
                }
                const jsonDataString = await jsonDataFile.async("string");
                const importedData = JSON.parse(jsonDataString);
                
                // 3. æ¢å¤æ—è°±æ•°æ®
                familyTree = importedData.familyTree || [];
                generationInfo = importedData.generationInfo || {};
                
                // 4. è¯»å–åª’ä½“æ–‡ä»¶å¹¶é‡å»º Data URLs
                const mediaFiles = {};
                const mediaFolder = zipContent.folder("media");
                if (mediaFolder) {
                    const mediaFileList = Object.values(mediaFolder.files);
                    for (const mediaFile of mediaFileList) {
                        if (!mediaFile.dir) { // ç¡®ä¿ä¸æ˜¯æ–‡ä»¶å¤¹
                            const relativePath = mediaFile.name;
                            // çŒœæµ‹ MIME ç±»å‹ (å¯ä»¥æ ¹æ®æ‰©å±•åæ›´ç²¾ç¡®åœ°åš)
                            let mimeType = 'application/octet-stream';
                            if (relativePath.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)) {
                                const ext = relativePath.split('.').pop().toLowerCase();
                                mimeType = `image/${ext === 'jpg' ? 'jpeg' : ext}`;
                            } else if (relativePath.match(/\.(mp4|webm|ogg|avi)$/i)) {
                                mimeType = 'video/mp4'; // ç®€åŒ–å¤„ç†
                            } else if (relativePath.match(/\.(mp3|wav|ogg)$/i)) {
                                mimeType = 'audio/mpeg'; // ç®€åŒ–å¤„ç†
                            }
                            const base64Data = await mediaFile.async("base64");
                            const dataUrl = `data:${mimeType};base64,${base64Data}`;
                            mediaFiles[relativePath] = dataUrl;
                        }
                    }
                }
                // 5. å°†å¯¼å…¥çš„æ•°æ®å’Œé‡å»ºçš„åª’ä½“ URL åˆå¹¶åˆ°ä¸»æ—è°±æ•°æ®ä¸­
                // é¦–å…ˆæ›´æ–° nextId ä»¥é¿å… ID å†²çª
                const maxIdInImport = Math.max(...familyTree.map(p => p.id), 0);
                nextId = Math.max(nextId, maxIdInImport + 1);
                // ç„¶åå°†å¯¼å…¥çš„æ•°æ®åˆå¹¶åˆ°ç°æœ‰æ—è°±ä¸­
                // è¿™é‡Œé‡‡ç”¨ç®€å•æ›¿æ¢çš„æ–¹å¼ï¼Œå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„åˆå¹¶é€»è¾‘
                familyTree = familyTree.map(person => {
                    // æ¢å¤å¤´åƒ URL
                    if (person.avatarUrl && mediaFiles[person.avatarUrl]) {
                        person.avatarUrl = mediaFiles[person.avatarUrl];
                    }
                    // æ¢å¤æ¡ç›®ä¸­çš„åª’ä½“ URL
                    ['biography', 'afterlife', 'graveLocation'].forEach(field => {
                        if (person[field] && Array.isArray(person[field])) {
                            person[field].forEach(entry => {
                                if (entry.media && Array.isArray(entry.media)) {
                                    entry.media.forEach(mediaItem => {
                                        if (mediaItem.content && mediaFiles[mediaItem.content]) {
                                            mediaItem.content = mediaFiles[mediaItem.content];
                                        }
                                    });
                                }
                            });
                        }
                    });
                    return person;
                });
                renderFamilyTree();
                alert('æ—è°±å¯¼å…¥æˆåŠŸï¼');
            } catch (error) {
                console.error("å¯¼å…¥å¤±è´¥:", error);
                alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
            } finally {
                event.target.value = ''; // æ¸…ç©º input
            }
        }
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = init;
    </script>
</body>
</html>